name: Build APK
on:
 push:
   branches: [ main ]
 workflow_dispatch:
jobs:
 build:
   runs-on: ubuntu-latest
   steps:
     - name: Checkout code
       uses: actions/checkout@v4
     - name: Set up JDK 17
       uses: actions/setup-java@v4
       with:
         java-version: '17'
         distribution: 'temurin'
     - name: Show repo structure
       run: find . -maxdepth 4 -not -path './.git/*' | sort
     - name: Set up Android SDK
       uses: android-actions/setup-android@v3
     - name: Setup Gradle
       uses: gradle/actions/setup-gradle@v3
       with:
         gradle-version: '8.4'
     - name: Find project and generate gradlew if missing
       run: |
         GRADLEW=$(find . -name "gradlew" -not -path "./.git/*" | head -1)
         if [ -z "$GRADLEW" ]; then
           echo "gradlew not found, generating..."
           PROJ_DIR=$(find . -name "settings.gradle" -not -path "./.git/*" | head -1 | xargs dirname)
           cd "$PROJ_DIR"
           gradle wrapper --gradle-version 8.4
         else
           PROJ_DIR=$(dirname "$GRADLEW")
           cd "$PROJ_DIR"
         fi
         chmod +x gradlew
         echo "PROJ_DIR=$(pwd)" >> $GITHUB_ENV
     - name: Build Debug APK
       run: |
         cd "$PROJ_DIR"
         ./gradlew assembleDebug --stacktrace
     - name: Find APK path
       run: |
         APK=$(find . -name "*.apk" | head -1)
         echo "APK_PATH=$APK" >> $GITHUB_ENV
         echo "Found APK: $APK"
     - name: Upload APK
       uses: actions/upload-artifact@v4
       with:
         name: MohanAltura-Receipt-APK
         path: ${{ env.APK_PATH }}
